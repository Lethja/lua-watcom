name: Lua for Watcom

on: push

jobs:
  Watcom:
    name: Lua for Watcom
    runs-on: ubuntu-latest

    steps:
    - uses: open-watcom/setup-watcom@v0
      with:
        version: "1.9"
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Build Lua for DOS 16-bit
      run: |
        export INCLUDE=$WATCOM/h
        wmake -f wm_dos16.mak

    - name: Build Lua for DOS4GW
      run: |
        export INCLUDE=$WATCOM/h
        wmake -f wm_dos4g.mak

    - name: Build Lua for WinNT
      run: |
        export INCLUDE=$WATCOM/h/nt:$WATCOM/h
        wmake -f wm_winnt.mak

    - name: UPX Binary Compression
      uses: crazy-max/ghaction-upx@v3
      with:
        version: latest
        args: -9 --8086
        files: |
          dist/bin/*.exe

    - name: Copy DOS4GW Binary
      run: |
          cp $WATCOM/binw/dos4gw.exe dist/bin/

    - name: Install Post Build Packaging Tools
      run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix mtools zip

    - name: Ensure Lua Scripts Have CR/LF Line Endings
      run: |
          unix2dos *.lua

    - name: Create 160k Floppy Diskette Image
      run: |
          mformat -C -i dist/Lua5DD8.ima -v LUA -f 160
          mcopy -i dist/Lua5DD8.ima dist/bin/lua16.exe example.lua ::

    - name: Create 1.4M Floppy Diskette Image
      run: |
          mformat -C -i dist/Lua3HD18.ima -v LUA -f 1440
          mcopy -i dist/Lua3HD18.ima dist/bin/*.exe example.lua ::

    - name: Create Zip Binaries
      run: |
          zip -j9 "dist/Lua DOS Bin.zip" dist/bin/*.exe

    - name: Zip Disk Images
      run: |
          zip -j9 "dist/Lua DOS Ima.zip" dist/*.ima

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: 'Lua Binaries'
        path: dist/*.zip
        compression-level: 0
